<!doctype html>
<html lang="en">
<head>
  <!-- ... existing head ... -->
  <style>
    /* ... existing styles ... */

    /* Explanation / base-ten */
    .explain{
      margin-top:8px;background:rgba(255,255,255,0.01);padding:12px;border-radius:8px;font-size:14px;color:var(--muted)
    }
    /* Preserve line breaks and improve readability */
    #explainText{ white-space: pre-line }
    .step-list{ margin:8px 0 0; padding-left:18px }
    .step-list li{ margin:4px 0 }

    .blocks{
      display:flex;gap:8px;align-items:flex-end;margin-top:10px;
      /* Prevent overlap by wrapping and allowing scroll when needed */
      flex-wrap: wrap;
    }
    /* If columns overflow, allow horizontal scrolling inside Explain box */
    #blocksArea{ overflow-x: auto }

    /* ... rest of styles ... */
  </style>
</head>
<body>
  <!-- ... existing HTML markup ... -->

  <script>
    // ... existing JS above ...

    function renderSolvedList(){
      solvedList.innerHTML = '';
      const list = state.solved.slice().reverse();
      list.forEach((it) => {
        const div = document.createElement('div');
        div.className = 'solved-item';

        const left = document.createElement('div');
        const mini = document.createElement('div');
        mini.className = 'vertical-add mini';

        // Carry row (typed-only) — FIX: add carry cells first, placeholder last
        const carryRowMini = document.createElement('div');
        carryRowMini.className = 'grid-row';
        for(let j=1; j<=it.digits; j++){
          const cell = document.createElement('div');
          cell.className = 'carry-cell';
          cell.textContent = (it.finalCarryInputs && typeof it.finalCarryInputs[j] !== 'undefined') ? it.finalCarryInputs[j] : '';
          carryRowMini.appendChild(cell);
        }
        const ph = document.createElement('div');
        ph.className = 'carry-placeholder';
        carryRowMini.appendChild(ph);
        mini.appendChild(carryRowMini);

        // Addends rows
        const rowA = document.createElement('div'); rowA.className = 'grid-row';
        const rowB = document.createElement('div'); rowB.className = 'grid-row';
        for(let i=0;i<it.digits;i++){
          const da = Math.floor(it.a/Math.pow(10,i))%10;
          const db = Math.floor(it.b/Math.pow(10,i))%10;
          const cellA = document.createElement('div'); cellA.className='digit-cell'; cellA.textContent=da;
          const cellB = document.createElement('div'); cellB.className='digit-cell'; cellB.textContent=db;
          rowA.appendChild(cellA); rowB.appendChild(cellB);
        }
        mini.appendChild(rowA);
        mini.appendChild(rowB);

        const sep = document.createElement('div'); sep.className = 'separator';
        mini.appendChild(sep);

        // Sum row (typed-only)
        const sumMini = document.createElement('div'); sumMini.className = 'grid-row';
        for(let i=0;i<=it.digits;i++){
          const cell = document.createElement('div'); cell.className='digit-cell';
          cell.textContent = (it.finalUserDigitsRaw && typeof it.finalUserDigitsRaw[i] !== 'undefined') ? it.finalUserDigitsRaw[i] : '';
          sumMini.appendChild(cell);
        }
        mini.appendChild(sumMini);

        // Meta
        const meta1 = document.createElement('div');
        meta1.style.fontSize = '12px'; meta1.style.color = 'var(--muted)';
        meta1.textContent = `${it.a} + ${it.b}`;
        const meta2 = document.createElement('div');
        meta2.style.fontSize = '12px'; meta2.style.color = 'var(--muted)';
        meta2.textContent = `Attempts: ${it.attempts}`;
        mini.appendChild(meta1);
        mini.appendChild(meta2);

        left.appendChild(mini);

        const right = document.createElement('div');
        right.className = 'right';
        const status = document.createElement('div');
        status.textContent = it.correct ? 'Correct' : 'Wrong';
        status.className = it.correct ? 'solved-correct' : 'solved-wrong';
        const time = document.createElement('div');
        time.style.fontSize = '12px'; time.style.color = 'var(--muted)'; time.textContent = new Date(it.timestamp).toLocaleTimeString();
        right.appendChild(status);
        right.appendChild(time);

        div.appendChild(left);
        div.appendChild(right);
        solvedList.appendChild(div);
      });
    }

    function downloadSolvedPDF(){
      if(state.solved.length === 0){ alert('No solved problems yet.'); return; }

      const printWindow = window.open('', '_blank', 'width=800,height=1000,scrollbars=yes');
      if(!printWindow) {
        alert('Unable to open print window (popup blocked).');
        return;
      }
      const doc = printWindow.document;
      const style = `
        body{font-family:Arial,Helvetica,sans-serif;color:#111;padding:20px}
        h1{font-size:20px;margin-bottom:8px}
        p{margin:0 0 12px}
        .solv{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:8px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:10px}
        .status{font-weight:700}
        .status.correct{color:#16a34a}
        .status.wrong{color:#ef4444}
        .vertical-add{background:#f7fafc;padding:12px;border-radius:8px;border:1px solid #e5e7eb;display:flex;flex-direction:column;gap:6px;min-width:auto}
        .grid-row{display:flex;flex-direction:row-reverse;gap:6px;align-items:center}
        .digit-cell,.carry-cell,.carry-placeholder{
          width:32px;min-width:32px;height:32px;min-height:32px;
          box-sizing:border-box;text-align:center;border-radius:6px;
          font-family:Courier New,ui-monospace,monospace;font-size:18px;
          display:flex;align-items:center;justify-content:center;
        }
        .carry-cell{border:1px dashed #cbd5e1;color:#0ea5e9;background:#f0f9ff}
        .carry-placeholder{border:1px dashed transparent}
        .separator{height:2px;background:linear-gradient(90deg,#22d3ee,transparent);border-radius:2px;margin:4px 0}
        .meta{font-size:12px;color:#64748b}
        @page{margin:20mm}
      `;
      doc.open();
      doc.write('<!doctype html><html><head><meta charset="utf-8"><title>Solved Addition — PDF</title>');
      doc.write('<style>'+style+'</style></head><body>');
      doc.write('<h1>Solved addition problems</h1>');
      doc.write('<p>Generated: '+ new Date().toLocaleString() +'</p>');

      state.solved.forEach((it) => {
        // FIX: add carry cells first, placeholder last to align left in reversed grid
        let carryHTML = '<div class="grid-row">';
        for(let j=1;j<=it.digits;j++){
          const val = (it.finalCarryInputs && typeof it.finalCarryInputs[j] !== 'undefined') ? it.finalCarryInputs[j] : '';
          carryHTML += `<div class="carry-cell">${val}</div>`;
        }
        carryHTML += '<div class="carry-placeholder"></div>';
        carryHTML += '</div>';

        let rowAHTML = '<div class="grid-row">';
        let rowBHTML = '<div class="grid-row">';
        for(let i=0;i<it.digits;i++){
          const da = Math.floor(it.a/Math.pow(10,i))%10;
          const db = Math.floor(it.b/Math.pow(10,i))%10;
          rowAHTML += `<div class="digit-cell">${da}</div>`;
          rowBHTML += `<div class="digit-cell">${db}</div>`;
        }
        rowAHTML += '</div>'; rowBHTML += '</div>';

        let sumHTML = '<div class="grid-row">';
        for(let i=0;i<=it.digits;i++){
          const val = (it.finalUserDigitsRaw && typeof it.finalUserDigitsRaw[i] !== 'undefined') ? it.finalUserDigitsRaw[i] : '';
          sumHTML += `<div class="digit-cell">${val}</div>`;
        }
        sumHTML += '</div>';

        doc.write(
          `<div class="solv">
            <div style="flex:1">
              <div class="vertical-add">
                ${carryHTML}
                ${rowAHTML}
                ${rowBHTML}
                <div class="separator"></div>
                ${sumHTML}
                <div class="meta">${it.a} + ${it.b}</div>
                <div class="meta">Attempts: ${it.attempts}</div>
              </div>
            </div>
            <div>
              <div class="status ${it.correct?'correct':'wrong'}">${it.correct?'Correct':'Wrong'}</div>
              <div class="meta">${new Date(it.timestamp).toLocaleString()}</div>
            </div>
          </div>`
        );
      });

      doc.write('</body></html>');
      doc.close();
      setTimeout(()=>{ printWindow.focus(); printWindow.print(); }, 350);
    }

    function showExplanation(){
      const a = state.a, b = state.b, d = state.digits;

      // Build a clear, ordered step list
      const steps = [];
      let carry = 0;
      for(let i=0;i<d;i++){
        const pow = Math.pow(10,i);
        const da = Math.floor(a/pow)%10;
        const db = Math.floor(b/pow)%10;
        const sum = da + db + carry;
        const digit = sum % 10;
        const newCarry = Math.floor(sum/10);
        const placeName = i===0 ? "ones" : i===1 ? "tens" : i===2 ? "hundreds" : `${i+1}-place`;
        steps.push(`Add the ${placeName}: ${da} + ${db}` + (carry?` + carry ${carry}`:'') + ` = ${sum}. Write ${digit}` + (newCarry?` and carry ${newCarry}.`:`.`));
        carry = newCarry;
      }
      if(carry){
        steps.push(`After the leftmost column, carry ${carry} becomes an extra leftmost digit.`);
      }

      // Render as an ordered list (more readable than a single paragraph)
      explainText.innerHTML = `<div style="font-weight:700;color:#e6eef6;margin-bottom:6px">Step-by-step</div><ol class="step-list">` +
        steps.map(s => `<li>${s}</li>`).join('') +
        `</ol>`;

      explainBox.hidden = false;
      blocksArea.hidden = false;

      // Populate carry boxes for Explain view (auto-marked so they don't count as user input)
      const carries = (() => {
        const arr = new Array(d).fill(0);
        let c = 0;
        for(let i=0;i<d;i++){
          const pow = Math.pow(10,i);
          const da = Math.floor(state.a/pow)%10;
          const db = Math.floor(state.b/pow)%10;
          const s = da + db + c;
          c = Math.floor(s/10);
          arr[i] = c;
        }
        return arr;
      })();
      const carryCells = Array.from(carryRow.children);
      for(let j=0;j<carryCells.length;j++){
        const fromIndex = j-1;
        const desired = (fromIndex >= 0 && fromIndex < carries.length && carries[fromIndex]) ? String(carries[fromIndex]) : '';
        const cell = carryCells[j];
        if(cell.tagName === 'INPUT'){
          if(cell.value === '' || cell.value === null){
            cell.value = desired;
            cell.dataset.autovalue = 'explain';
            cell.style.border = '1px solid rgba(34,211,238,0.18)';
          } else {
            const parsed = parseInt(cell.value,10) || 0;
            cell.style.border = parsed === (fromIndex >= 0 && fromIndex < carries.length ? carries[fromIndex] : 0) ? '1px solid rgba(34,211,238,0.18)' : '1px solid rgba(239,68,68,0.18)';
          }
        }
      }

      // Base-ten visualization (now wraps, avoids overlap)
      blocksColumns.innerHTML = '';
      for(let i=d-1;i>=0;i--){
        const col = document.createElement('div');
        col.className='column';
        const placeName = i===0 ? 'Ones' : i===1 ? 'Tens' : i===2 ? 'Hundreds' : (i+1)+'-place';
        const title = document.createElement('div'); title.style.fontSize='12px'; title.style.color='var(--muted)';
        title.textContent = placeName;
        col.appendChild(title);

        const pow = Math.pow(10,i);
        const da = Math.floor(state.a/pow)%10;
        const db = Math.floor(state.b/pow)%10;

        const groupA = document.createElement('div'); groupA.style.display='flex'; groupA.style.flexDirection='column'; groupA.style.alignItems='center'; groupA.style.gap='4px';
        const labelA = document.createElement('div'); labelA.style.fontSize='12px'; labelA.style.color='var(--muted)'; labelA.textContent='A:';
        groupA.appendChild(labelA);
        for(let k=0;k<da;k++){
          const block = document.createElement('div');
          block.className = i===0 ? 'block' : 'block ten';
          groupA.appendChild(block);
        }
        col.appendChild(groupA);

        const sep = document.createElement('div'); sep.style.height='6px';
        col.appendChild(sep);

        const groupB = document.createElement('div'); groupB.style.display='flex'; groupB.style.flexDirection='column'; groupB.style.alignItems='center'; groupB.style.gap='4px';
        const labelB = document.createElement('div'); labelB.style.fontSize='12px'; labelB.style.color='var(--muted)'; labelB.textContent='B:';
        groupB.appendChild(labelB);
        for(let k=0;k<db;k++){
          const block = document.createElement('div');
          block.className = i===0 ? 'block' : 'block ten';
          groupB.appendChild(block);
        }
        col.appendChild(groupB);

        blocksColumns.appendChild(col);
      }
    }

    // ... rest of JS (newProblem, etc.) ...
  </script>
</body>
</html>
