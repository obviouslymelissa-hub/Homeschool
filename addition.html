<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Addition with Regrouping — Practice</title>
  <meta name="description" content="Clean interactive practice for addition with regrouping — made for a tech-loving homeschooler." />

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1724;
      --muted:#9aa4b2;
      --accent:#22d3ee;
      --accent-2:#7c3aed;
      --good:#16a34a;
      --bad:#ef4444;
      --card:#071025;
      --glass: rgba(255,255,255,0.03);
      font-synthesis: none;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg),#031025 120%);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
      box-sizing:border-box;
    }

    .wrap{
      max-width:1000px;
      margin:0 auto;
    }

    header{
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:18px;
    }
    .logo{
      width:64px;height:64px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#021022;font-size:20px;
      box-shadow:0 6px 20px rgba(34,211,238,0.12);
    }
    h1{margin:0;font-size:20px;}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .layout{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:20px;
      margin-top:18px;
    }

    .card{
      background:linear-gradient(180deg,var(--panel),#07142a);
      border-radius:12px;padding:16px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }

    /* Controls */
    .controls label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .controls .row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    select,input[type="number"],input[type="checkbox"]{
      background:var(--glass);border:1px solid rgba(255,255,255,0.04);
      color:inherit;padding:8px;border-radius:8px;font-size:14px;width:100%;
      box-sizing:border-box;
    }
    .switch{
      display:flex;gap:8px;align-items:center;
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#021022;font-weight:700;padding:10px 14px;border-radius:10px;border:none;
      cursor:pointer; box-shadow:0 8px 18px rgba(7,20,40,0.4);
    }
    .btn.ghost{
      background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--accent);
    }
    .tiny{font-size:13px;padding:6px 9px;border-radius:8px}

    /* Problem area */
    .stage{
      display:flex;flex-direction:column;gap:12px;align-items:stretch;
    }

    .problem-card{
      padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
      display:flex;gap:16px;align-items:flex-start;
    }
    .vertical-add{
      background:linear-gradient(180deg,#041426 80%,transparent);
      padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      min-width:260px;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* unified sizes so everything lines up */
    .grid-row{
      display:flex;
      flex-direction:row-reverse; /* rightmost column is the first child visually (ones) */
      gap:6px;
      align-items:center;
    }

    .digit-cell, .carry-input, .digit-input, .carry-placeholder {
      width:44px;
      min-width:44px;
      box-sizing:border-box;
      text-align:center;
      border-radius:6px;
      font-family: "Courier New", ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    }

    .digit-cell{
      padding:8px 6px;
      font-size:28px;
      color:#e6eef6;
      background:transparent;
      border:1px solid transparent;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .carry-input{
      padding:6px 6px;
      font-size:16px;
      background:rgba(255,255,255,0.02);
      border:1px dashed rgba(255,255,255,0.04);
      color:var(--accent);
      height:36px;
    }

    .carry-placeholder{
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(255,255,255,0.06);
      border:1px dashed transparent;
      background:transparent;
    }

    .digit-input{
      padding:6px 6px;
      font-size:20px;
      background:transparent;
      border:1px dashed rgba(255,255,255,0.05);
      color:inherit;
      height:44px;
    }

    .separator{height:2px;background:linear-gradient(90deg,var(--accent),transparent);margin:6px 0;border-radius:2px}

    .sum-row{display:flex;gap:6px;align-items:center}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}

    /* Stats */
    .stats{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:13px;min-width:88px;text-align:center}
    .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}

    /* Explanation / base-ten */
    .explain{
      margin-top:8px;background:rgba(255,255,255,0.01);padding:12px;border-radius:8px;font-size:14px;color:var(--muted)
    }
    .blocks{
      display:flex;gap:8px;align-items:flex-end;margin-top:10px;
    }
    .column{
      min-width:60px;height:120px;background:rgba(255,255,255,0.01);padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);
      display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
      gap:6px;
    }
    .block{
      width:28px;height:16px;background:linear-gradient(90deg,#ffd27c,#ffb86b);border-radius:4px;border:1px solid rgba(0,0,0,0.12);
    }
    .block.ten{width:56px;height:16px;background:linear-gradient(90deg,#8be3ff,#22d3ee);}

    /* feedback */
    .correct{border:1px solid rgba(22,163,74,0.18);box-shadow:0 6px 22px rgba(22,163,74,0.06)}
    .wrong{border:1px solid rgba(239,68,68,0.14);box-shadow:0 6px 22px rgba(239,68,68,0.04)}

    /* footer help */
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

    /* responsive */
    @media (max-width:860px){
      .layout{grid-template-columns:1fr; }
      .vertical-add{min-width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">ADD</div>
      <div>
        <h1>Addition with Regrouping — Practice</h1>
        <p class="lead">A clean, interactive page for learning addition with regrouping — made for a tech-loving homeschool student. Choose settings and try problems, see step-by-step regrouping, or visualize with base-ten blocks.</p>
      </div>
    </header>

    <div class="layout">
      <aside class="card controls" aria-labelledby="controls-heading">
        <h3 id="controls-heading" style="margin-top:0">Settings</h3>

        <div class="row">
          <label for="digits">Digits per addend</label>
          <select id="digits" title="Select number of digits">
            <option value="2">2 digits (e.g., 34 + 17)</option>
            <option value="3" selected>3 digits (e.g., 248 + 167)</option>
            <option value="1">1 digit (practice)</option>
            <option value="4">4 digits (challenge)</option>
          </select>
        </div>

        <div class="row">
          <label for="forceRegroup">Force regrouping?</label>
          <select id="forceRegroup" title="Require at least one regroup in the problem">
            <option value="either">Either</option>
            <option value="yes">Yes — at least one regroup</option>
            <option value="no">No regroup</option>
          </select>
        </div>

        <div class="row">
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="practice" selected>Practice (step help)</option>
            <option value="challenge">Challenge (timer & streak)</option>
          </select>
        </div>

        <div class="row">
          <label for="problems">Problems per session</label>
          <input id="problems" type="number" min="1" max="50" value="10" />
        </div>

        <div class="row">
          <label style="font-size:13px;color:var(--muted)">Show carry boxes on top</label>
          <input id="showCarryBoxes" type="checkbox" aria-label="Show carry boxes" checked />
        </div>

        <div class="row" style="margin-top:4px">
          <button id="newBtn" class="btn tiny" title="New problem">New problem</button>
          <button id="checkBtn" class="btn ghost tiny" title="Check answer">Check</button>
          <button id="explainBtn" class="btn ghost tiny" title="Show step-by-step">Explain</button>
        </div>

        <div style="margin-top:12px">
          <div class="stats">
            <div class="stat">Asked: <strong id="asked">0</strong></div>
            <div class="stat">Correct: <strong id="correct">0</strong></div>
            <div class="stat">Streak: <strong id="streak">0</strong></div>
          </div>

          <div style="margin-top:10px">
            <div class="progress" aria-hidden="true" style="margin-bottom:6px"><i id="progBar"></i></div>
            <div class="hint">Tip: press Enter to submit, use arrow keys to move between digit boxes. You can type carries in the top boxes to practice.</div>
          </div>
        </div>
      </aside>

      <main class="card stage" aria-live="polite">
        <div class="problem-card" id="problemCard">
          <div class="vertical-add" id="verticalAdd" role="group" aria-label="Addition problem">
            <!-- carries (optional) - now has one extra cell on the left to accept overflow carry -->
            <div id="carryRow" class="grid-row" aria-hidden="true"></div>

            <!-- addends -->
            <div id="addendRowA" class="grid-row" aria-hidden="true" title="Addend A"></div>
            <div id="addendRowB" class="grid-row" aria-hidden="true" title="Addend B"></div>

            <div class="separator" aria-hidden="true"></div>

            <!-- sum row (has one extra leftmost box to accept overflow digit) -->
            <div class="grid-row" id="sumRow" role="group" aria-label="Your answer">
              <!-- digit inputs added by JS -->
            </div>

            <div class="hint" id="problemHint">Generate a new problem to begin.</div>
          </div>

          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-size:12px;color:var(--muted)">Current mode</div>
                <div style="font-weight:700">Practice</div>
              </div>
              <div>
                <button id="showBlocksBtn" class="btn tiny" title="Show base-ten visualization">Show base-ten</button>
              </div>
            </div>

            <div id="explain" class="explain" hidden>
              <div id="explainText">Explanation will appear here.</div>

              <div id="blocksArea" style="margin-top:10px" hidden>
                <div style="font-size:13px;color:var(--muted)">Columns (right = ones)</div>
                <div class="blocks" id="blocksColumns">
                  <!-- base-ten columns inserted by JS -->
                </div>
              </div>
            </div>

            <div id="gameInfo" style="margin-top:12px;color:var(--muted);font-size:13px">
              <div id="sessionInfo"></div>
            </div>
          </div>
        </div>

        <footer>
          If you want, I can adjust difficulty, add more visuals, or make printable worksheets. Tell me what to change.
        </footer>
      </main>
    </div>
  </div>

  <script>
    // Improved alignment + overflow digit support.
    // Key change: sum row and carry row now include the extra leftmost column so sums like 6+4 -> 10 can be entered as two digits.
    (function(){
      // DOM refs
      const digitsSelect = document.getElementById('digits');
      const forceRegroup = document.getElementById('forceRegroup');
      const modeSelect = document.getElementById('mode');
      const problemsInput = document.getElementById('problems');
      const newBtn = document.getElementById('newBtn');
      const checkBtn = document.getElementById('checkBtn');
      const explainBtn = document.getElementById('explainBtn');
      const showBlocksBtn = document.getElementById('showBlocksBtn');
      const showCarryBoxes = document.getElementById('showCarryBoxes');

      const carryRow = document.getElementById('carryRow');
      const addendRowA = document.getElementById('addendRowA');
      const addendRowB = document.getElementById('addendRowB');
      const sumRow = document.getElementById('sumRow');
      const problemHint = document.getElementById('problemHint');
      const explainBox = document.getElementById('explain');
      const explainText = document.getElementById('explainText');
      const blocksArea = document.getElementById('blocksArea');
      const blocksColumns = document.getElementById('blocksColumns');

      // stats
      const askedEl = document.getElementById('asked');
      const correctEl = document.getElementById('correct');
      const streakEl = document.getElementById('streak');
      const progBar = document.getElementById('progBar');
      const sessionInfo = document.getElementById('sessionInfo');

      let state = {
        a: null,
        b: null,
        digits: 3,         // digits in each addend
        willForce: 'either',
        asked: 0,
        correct: 0,
        streak: 0,
        sessionTotal: 10,
        sessionDone: 0
      };

      // helpers
      function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

      function makeAddends(digits, force){
        while(true){
          const max = Math.pow(10,digits)-1;
          const min = digits===1 ? 0 : Math.pow(10,digits-1);
          const a = randInt(min, max);
          const b = randInt(min, max);
          const columns = columnSums(a,b,digits);
          const hasRegroup = columns.some(s => s>=10);
          if(force === 'yes' && !hasRegroup) continue;
          if(force === 'no' && hasRegroup) continue;
          return {a,b};
        }
      }

      function columnSums(a,b,digits){
        const arr=[];
        for(let i=0;i<digits;i++){
          const pow=Math.pow(10,i);
          const da = Math.floor(a/pow)%10;
          const db = Math.floor(b/pow)%10;
          arr.push(da+db);
        }
        return arr; // ones first
      }

      // render vertical layout using consistent grid-row sizes
      function renderProblem(){
        const d = state.digits;          // number of digits in addends
        const a = state.a;
        const b = state.b;
        carryRow.innerHTML = '';
        addendRowA.innerHTML = '';
        addendRowB.innerHTML = '';
        sumRow.innerHTML = '';

        // carryRow: create d+1 cells so there's a leftmost carry cell (overflow),
        // and the rightmost (ones) is a placeholder (no carry goes above ones).
        for(let j=0;j<=d;j++){ // j from 0..d inclusive, total d+1 cells
          if(j === 0){
            // rightmost (ones) — placeholder (no carry box above ones)
            const placeholder = document.createElement('div');
            placeholder.className = 'carry-placeholder';
            placeholder.textContent = '';
            placeholder.setAttribute('aria-hidden', 'true');
            carryRow.appendChild(placeholder);
          } else {
            // j >= 1 => carry input that represents carry into column j (from column j-1)
            const carryInput = document.createElement('input');
            carryInput.type = 'text';
            carryInput.className = 'carry-input';
            carryInput.maxLength = 2;
            carryInput.dataset.idx = j;
            carryInput.setAttribute('aria-label','carry for column '+(j+1));
            carryInput.addEventListener('input', e => {
              // keep only digits
              e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0,2);
            });
            carryRow.appendChild(carryInput);
          }
        }
        carryRow.style.display = showCarryBoxes.checked ? 'flex' : 'none';

        // addends (A and B): each has exactly d visible digit cells (no extra leftmost)
        for(let i=0;i<d;i++){
          const pow = Math.pow(10,i);
          const da = Math.floor(a/pow)%10;
          const db = Math.floor(b/pow)%10;
          const cellA = document.createElement('div'); cellA.className='digit-cell'; cellA.textContent=da;
          const cellB = document.createElement('div'); cellB.className='digit-cell'; cellB.textContent=db;
          addendRowA.appendChild(cellA);
          addendRowB.appendChild(cellB);
        }

        // sumRow: create d+1 inputs (rightmost is ones at index 0, leftmost index d is overflow digit)
        for(let i=0;i<=d;i++){
          const input = document.createElement('input');
          input.type='text'; input.inputMode='numeric';
          input.maxLength=3; input.className='digit-input';
          input.dataset.idx = i;
          input.setAttribute('aria-label','digit '+(i+1));
          input.addEventListener('keydown', handleKeyNav);
          input.addEventListener('input', enforceDigits);
          sumRow.appendChild(input);
        }

        // instruction
        problemHint.textContent = 'Add the two numbers above. Enter each digit of the sum in the boxes — rightmost box is ones. If the sum produces an extra digit on the left (e.g., 6+4=10), use the leftmost box to enter that digit. The carry boxes above correspond to carries into the next column (there is no box above the ones column).';
        explainBox.hidden = true;
        blocksArea.hidden = true;

        // focus right-most sum input (ones)
        setTimeout(() => {
          const inputs = sumRow.querySelectorAll('input');
          if(inputs.length) inputs[0].focus();
        }, 50);
      }

      function enforceDigits(e){
        // allow only digits
        const v = e.target.value.replace(/[^\d]/g,'');
        e.target.value = v;
      }

      function handleKeyNav(e){
        const idx = Number(e.target.dataset.idx);
        const inputs = Array.from(sumRow.querySelectorAll('input'));
        if(e.key === 'ArrowLeft'){ // move to next (more significant)
          e.preventDefault();
          if(idx+1 < inputs.length) inputs[idx+1].focus();
        } else if(e.key === 'ArrowRight'){
          e.preventDefault();
          if(idx-1 >= 0) inputs[idx-1].focus();
        } else if(e.key === 'Enter'){
          e.preventDefault();
          checkAnswer();
        }
      }

      function getUserDigits(){
        const inputs = Array.from(sumRow.querySelectorAll('input'));
        // inputs[0] is ones, inputs[d] is leftmost overflow
        const d = inputs.map(i => i.value.trim()===''?null:parseInt(i.value,10));
        return d;
      }

      function computeSumArray(){
        const d = state.digits;
        const total = state.a + state.b;
        const arr=[];
        // produce d+1 digits (ones .. overflow)
        for(let i=0;i<=d;i++){
          arr.push(Math.floor(total/Math.pow(10,i))%10);
        }
        return arr;
      }

      // compute carries column-by-column (ones-first).
      // returns carries array length d where carries[i] is the carry produced after processing column i (goes into column i+1).
      function computeCarries(){
        const d = state.digits;
        const carries = new Array(d).fill(0);
        let carry = 0;
        for(let i=0;i<d;i++){
          const pow = Math.pow(10,i);
          const da = Math.floor(state.a/pow)%10;
          const db = Math.floor(state.b/pow)%10;
          const s = da + db + carry;
          carry = Math.floor(s/10);
          carries[i] = carry;
        }
        return carries;
      }

      function checkAnswer(){
        const user = getUserDigits();     // length d+1
        const expected = computeSumArray(); // length d+1
        if(user.some(v=>v===null)){
          flashProblem('Please fill every digit box (use 0 if needed).', false);
          return;
        }
        let allGood = true;
        const inputs = Array.from(sumRow.querySelectorAll('input'));
        // clear previous markers
        inputs.forEach(i => {
          i.style.border='1px dashed rgba(255,255,255,0.05)';
          i.style.background = 'transparent';
        });

        for(let i=0;i<expected.length;i++){
          if(user[i] === expected[i]){
            inputs[i].style.background = 'linear-gradient(90deg, rgba(34,211,238,0.06), rgba(124,58,237,0.02))';
            inputs[i].style.border = '1px solid rgba(34,211,238,0.18)';
          } else {
            inputs[i].style.background = 'linear-gradient(90deg, rgba(239,68,68,0.02), transparent)';
            inputs[i].style.border = '1px solid rgba(239,68,68,0.18)';
            allGood = false;
          }
        }

        state.asked++;
        askedEl.textContent = state.asked;

        const carries = computeCarries();
        // show carries briefly in the boxes above (mapping: carry produced by column i appears above column i+1)
        showCarriesBrief(carries);

        if(allGood){
          flashProblem('Correct! Nice work.', true);
          state.correct++;
          state.streak++;
          correctEl.textContent = state.correct;
          streakEl.textContent = state.streak;
          confetti();
        } else {
          flashProblem('Not quite — press "Explain" for a guided step-by-step.', false);
          state.streak = 0;
          streakEl.textContent = state.streak;
        }

        state.sessionDone++;
        updateProgress();
      }

      // shows computed carries briefly; mapping: carry produced at index i is shown in carry cell at index i+1
      function showCarriesBrief(carries){
        const carryCells = Array.from(carryRow.children); // length d+1
        if(!carryCells.length) return;
        const autoSet = [];
        for(let j=0;j<carryCells.length;j++){
          const cell = carryCells[j];
          // desired carry to display above this column: carry from previous column (j-1)
          const fromIndex = j-1; // fromIndex in carries array
          const desired = (fromIndex >= 0 && fromIndex < carries.length && carries[fromIndex]) ? String(carries[fromIndex]) : '';
          if(cell.tagName === 'INPUT'){
            if(cell.value === '' || cell.value === null){
              cell.dataset.autovalue = desired;
              cell.value = desired;
              cell.style.border = '1px solid rgba(34,211,238,0.18)';
              cell.style.background = 'linear-gradient(90deg, rgba(34,211,238,0.04), transparent)';
              autoSet.push(cell);
            } else {
              const parsed = parseInt(cell.value,10) || 0;
              if(parsed === (fromIndex >= 0 && fromIndex < carries.length ? carries[fromIndex] : 0)){
                cell.style.border = '1px solid rgba(34,211,238,0.18)';
              } else {
                cell.style.border = '1px solid rgba(239,68,68,0.18)';
              }
            }
          } else {
            // placeholder - keep empty
            cell.textContent = '';
          }
        }
        // clear autovalues after short delay
        setTimeout(()=>{
          autoSet.forEach(ci => {
            if(ci.dataset.autovalue !== undefined && ci.value === ci.dataset.autovalue){
              ci.value = '';
            }
            ci.style.border = '1px dashed rgba(255,255,255,0.04)';
            ci.style.background = 'rgba(255,255,255,0.02)';
            delete ci.dataset.autovalue;
          });
        }, 1400);
      }

      function flashProblem(msg, good){
        const card = document.getElementById('verticalAdd');
        card.classList.remove('correct','wrong');
        if(good) card.classList.add('correct'); else card.classList.add('wrong');
        problemHint.textContent = msg;
        setTimeout(()=>{ card.classList.remove('correct','wrong'); }, 1400);
      }

      function showExplanation(){
        const a = state.a, b = state.b, d = state.digits;
        let text = '';
        let carry=0;
        // explain from most significant down to ones for readability, then note overflow if any.
        for(let i=d-1;i>=0;i--){
          const place = Math.pow(10,i);
          const da = Math.floor(a/place)%10;
          const db = Math.floor(b/place)%10;
          const s = da + db + carry;
          const digit = s % 10;
          const newCarry = Math.floor(s/10);
          const placeName = i===0 ? "ones" : i===1 ? "tens" : i===2 ? "hundreds" : (i+1)+"-place";
          text += `Column ${i+1} (${placeName}): ${da} + ${db}` + (carry?` + carry ${carry}`:'') + ` = ${s}. Write ${digit} and carry ${newCarry}.\n`;
          carry = newCarry;
        }
        if(carry){
          text += `After the leftmost column there is a final carry of ${carry}, so the sum has an extra leftmost digit (${carry}).\n`;
        }
        explainText.textContent = text;
        explainBox.hidden = false;
        blocksArea.hidden = false;

        // compute carries and populate carry boxes above appropriate columns
        const carries = computeCarries();
        const carryCells = Array.from(carryRow.children);
        for(let j=0;j<carryCells.length;j++){
          const fromIndex = j-1;
          const desired = (fromIndex >= 0 && fromIndex < carries.length && carries[fromIndex]) ? String(carries[fromIndex]) : '';
          const cell = carryCells[j];
          if(cell.tagName === 'INPUT'){
            if(cell.value === '' || cell.value === null){
              cell.value = desired;
              cell.dataset.autovalue = 'explain';
              cell.style.border = '1px solid rgba(34,211,238,0.18)';
            } else {
              const parsed = parseInt(cell.value,10) || 0;
              cell.style.border = parsed === (fromIndex >= 0 && fromIndex < carries.length ? carries[fromIndex] : 0) ? '1px solid rgba(34,211,238,0.18)' : '1px solid rgba(239,68,68,0.18)';
            }
          } else {
            cell.textContent = '';
          }
        }

        // create block visualization
        blocksColumns.innerHTML = '';
        for(let i=d-1;i>=0;i--){
          const col = document.createElement('div');
          col.className='column';
          const placeName = i===0 ? 'Ones' : i===1 ? 'Tens' : i===2 ? 'Hundreds' : (i+1)+'-place';
          const title = document.createElement('div'); title.style.fontSize='12px'; title.style.color='var(--muted)';
          title.textContent = placeName;
          col.appendChild(title);

          const pow = Math.pow(10,i);
          const da = Math.floor(a/pow)%10;
          const db = Math.floor(b/pow)%10;

          const groupA = document.createElement('div'); groupA.style.display='flex'; groupA.style.flexDirection='column'; groupA.style.alignItems='center'; groupA.style.gap='4px';
          const labelA = document.createElement('div'); labelA.style.fontSize='12px'; labelA.style.color='var(--muted)'; labelA.textContent='A:';
          groupA.appendChild(labelA);
          for(let k=0;k<da;k++){
            const block = document.createElement('div');
            block.className = i===0 ? 'block' : 'block ten';
            groupA.appendChild(block);
          }
          col.appendChild(groupA);

          const sep = document.createElement('div'); sep.style.height='6px';
          col.appendChild(sep);

          const groupB = document.createElement('div'); groupB.style.display='flex'; groupB.style.flexDirection='column'; groupB.style.alignItems='center'; groupB.style.gap='4px';
          const labelB = document.createElement('div'); labelB.style.fontSize='12px'; labelB.style.color='var(--muted)'; labelB.textContent='B:';
          groupB.appendChild(labelB);
          for(let k=0;k<db;k++){
            const block = document.createElement('div');
            block.className = i===0 ? 'block' : 'block ten';
            groupB.appendChild(block);
          }
          col.appendChild(groupB);

          blocksColumns.appendChild(col);
        }
      }

      function confetti(){
        const count = 18;
        const container = document.createElement('div');
        container.style.position='fixed'; container.style.left=0; container.style.top=0; container.style.width='100%'; container.style.height='100%';
        container.style.pointerEvents='none'; container.style.overflow='hidden';
        document.body.appendChild(container);
        for(let i=0;i<count;i++){
          const el = document.createElement('div');
          const size = randInt(8,16);
          el.style.width = size+'px'; el.style.height = size+'px';
          el.style.position='absolute';
          el.style.left = randInt(10,90)+'%';
          el.style.top = '-10px';
          el.style.background = i%2? 'linear-gradient(90deg,#22d3ee,#7c3aed)':'linear-gradient(90deg,#ffd27c,#ffb86b)';
          el.style.opacity = Math.random()*0.95+0.2;
          el.style.transform = 'rotate('+randInt(0,360)+'deg)';
          el.style.borderRadius = '2px';
          el.style.zIndex = 9999;
          container.appendChild(el);
          const fall = randInt(800,1600);
          el.animate([
            { transform:`translateY(0) rotate(${randInt(0,360)}deg)`, opacity:1 },
            { transform:`translateY(${window.innerHeight + 80}px) rotate(${randInt(360,720)}deg)`, opacity:0.8 }
          ], { duration: fall, easing:'cubic-bezier(.2,.8,.2,1)' });
        }
        setTimeout(()=>{ document.body.removeChild(container); }, 1800);
      }

      function updateProgress(){
        const total = state.sessionTotal;
        const done = state.sessionDone;
        const pct = Math.min(100, Math.round((done/total)*100));
        progBar.style.width = pct + '%';
        sessionInfo.textContent = `Session: ${done} / ${total} done.`;
        if(done >= total){
          setTimeout(()=>{ alert(`Session complete! Correct ${state.correct} / ${state.asked}.`); }, 300);
        }
      }

      // generate a new problem
      function newProblem(){
        state.digits = parseInt(digitsSelect.value,10);
        state.willForce = forceRegroup.value;
        state.sessionTotal = Math.max(1, parseInt(problemsInput.value,10) || 10);

        const pair = makeAddends(state.digits, state.willForce);
        state.a = pair.a;
        state.b = pair.b;
        renderProblem();

        // clear stats for new session
        state.sessionDone = 0;
        state.asked = 0;
        state.correct = 0;
        state.streak = 0;
        askedEl.textContent = 0;
        correctEl.textContent = 0;
        streakEl.textContent = 0;
        progBar.style.width = '0%';
        sessionInfo.textContent = `Session: 0 / ${state.sessionTotal} done.`;
      }

      // when the carry boxes toggle changes, show/hide row (but keep data in DOM)
      showCarryBoxes.addEventListener('change', ()=>{
        carryRow.style.display = showCarryBoxes.checked ? 'flex' : 'none';
      });

      showBlocksBtn.addEventListener('click',()=>{
        explainBox.hidden = false;
        blocksArea.hidden = !blocksArea.hidden;
        if(!blocksArea.hidden) showExplanation();
      });

      explainBtn.addEventListener('click', () => {
        if(state.a===null) return;
        showExplanation();
      });

      newBtn.addEventListener('click', newProblem);
      checkBtn.addEventListener('click', checkAnswer);

      // keyboard shortcuts
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'n' && (e.ctrlKey || e.metaKey)){
          e.preventDefault(); newProblem();
        }
      });

      // initialize with a problem
      newProblem();

      // accessibility announcement
      function announceProblem(){
        const text = `Add ${state.a} and ${state.b}. Rightmost box is ones.`;
        problemHint.textContent = text;
      }
      announceProblem();

      // expose a few functions for debugging in console
      window._additionTool = {
        state,
        newProblem,
        checkAnswer,
        showExplanation
      };

    })();
  </script>
</body>
</html>
