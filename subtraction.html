<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Subtraction with Regrouping</title>
  <meta name="description" content="Interactive practice for subtraction with regrouping." />

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1724;
      --muted:#9aa4b2;
      --accent:#22d3ee;
      --accent-2:#7c3aed;
      --good:#16a34a;
      --bad:#ef4444;
      --card:#071025;
      --glass: rgba(255,255,255,0.03);
      font-synthesis: none;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg),#031025 120%);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
      box-sizing:border-box;
    }
    .wrap{max-width:1000px;margin:0 auto;}
    header{display:flex;gap:16px;align-items:center;margin-bottom:12px;}
    .logo{
      width:64px;height:64px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#021022;font-size:20px;
      box-shadow:0 6px 20px rgba(34,211,238,0.12);
    }
    h1{margin:0;font-size:20px;}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .layout{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:20px;
      margin-top:18px;
    }

    .card{
      background:linear-gradient(180deg,var(--panel),#07142a);
      border-radius:12px;padding:16px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }

    .btn{
      display:inline-flex;align-items:center;gap:8px;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#021022;font-weight:700;padding:10px 14px;border-radius:10px;border:none;
      cursor:pointer; box-shadow:0 8px 18px rgba(7,20,40,0.4);
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--accent);}
    .tiny{font-size:13px;padding:6px 9px;border-radius:8px}

    /* Problem area */
    .stage{display:flex;flex-direction:column;gap:12px;align-items:stretch;}
    .problem-card{
      padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
      display:flex;gap:16px;align-items:flex-start;
    }
    .vertical-add{
      background:linear-gradient(180deg,#041426 80%,transparent);
      padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      min-width:260px;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* unified sizes so everything lines up */
    .grid-row{
      display:flex;
      flex-direction:row-reverse; /* rightmost column is the first child visually (ones) */
      gap:6px;
      align-items:center;
    }

    .digit-cell, .digit-input {
      width:44px; min-width:44px; box-sizing:border-box; text-align:center;
      border-radius:6px;
      font-family: "Courier New", ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    }

    .digit-cell{
      padding:8px 6px; font-size:28px; color:#e6eef6; background:transparent; border:1px solid transparent;
      min-height:44px; display:flex; align-items:center; justify-content:center;
      position:relative; flex-direction:column;
    }
    
    .digit-cell.clickable-minuend {
      cursor: pointer;
      transition: all 260ms ease;
    }
    
    .digit-cell.clickable-minuend:hover {
      background: rgba(34,211,238,0.08);
      border: 1px solid rgba(34,211,238,0.2);
      transform: scale(1.05);
    }
    
    /* Borrowing visualization */
    .digit-cell .crossed-out{
      text-decoration:line-through; text-decoration-color:rgba(239,68,68,0.6); 
      text-decoration-thickness:2px; font-size:20px; color:rgba(230,238,246,0.4);
    }
    .digit-cell .borrowed-prefix{
      font-size:16px; color:var(--accent); font-weight:700; margin-right:2px;
      animation: pulse 600ms ease-in-out;
    }
    .digit-cell .regrouped-value{
      display:flex; align-items:center; justify-content:center; font-size:28px;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }
    
    .digit-cell.borrowed-indicator {
      border: 2px solid rgba(34, 211, 238, 0.4);
      background: rgba(34, 211, 238, 0.04);
      animation: glow 1s ease-in-out;
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(34, 211, 238, 0.2); }
      50% { box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); }
    }

    .digit-input{
      padding:6px 6px; font-size:20px; background:transparent;
      border:1px dashed rgba(255,255,255,0.05); color:inherit; height:44px;
    }

    .separator{
      height:2px;
      background:linear-gradient(90deg,var(--accent),transparent);
      margin:6px 0;
      border-radius:2px;
      position:relative;
    }
    .separator::before{
      content:'−'; /* minus sign */
      position:absolute;
      left:-0.4em;
      top:-0.2em;
      font-size:1.5em;
      color:var(--accent);
      font-weight:700;
    }

    .hint{font-size:13px;color:var(--muted);margin-top:8px}

    /* Stats */
    .stats{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:13px;min-width:88px;text-align:center}
    .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}

    /* Explanation */
    .explain{
      margin-top:8px;background:rgba(255,255,255,0.01);padding:12px;border-radius:8px;font-size:14px;color:var(--muted)
    }

    /* solved list etc. (unchanged styles omitted for brevity in this explanation) */

    /* Timer */
    .timer-badge{
      background:rgba(255,255,255,0.03);
      padding:6px 10px;border-radius:8px;font-weight:700;color:var(--accent);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    }

    /* NEW: place helper tiles (like tens-frames, but per place) */
    .place-helper-row {
      margin-top:6px;
      padding:6px;
      border-radius:8px;
      background:rgba(15,23,42,0.7);
      border:1px solid rgba(148,163,184,0.25);
    }
    .place-helper-label {
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .place-helper-grid {
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .place-tile {
      width:18px;
      height:18px;
      border-radius:4px;
      border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,23,42,0.6);
      box-sizing:border-box;
      transition:background 150ms ease,border-color 150ms ease,opacity 150ms ease,transform 80ms ease;
    }
    .place-tile.filled {
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      border-color:rgba(34,211,238,0.9);
      box-shadow:0 0 4px rgba(34,211,238,0.4);
    }
    .place-tile.dimmed {
      background:rgba(15,23,42,0.85);
      border-color:rgba(148,163,184,0.25);
      opacity:0.45;
      box-shadow:none;
    }

    .place-helper-summary {
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }

    /* Responsive */
    .controls-top { margin-top:12px; display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .controls-top .card{ padding:12px; display:flex; flex-direction:column; gap:8px; width:100%; }
    .controls-top .row{ margin:0; display:flex; gap:8px; align-items:center; width:100%; }
    .controls-top .stats{ margin-top:4px; }

    @media (max-width:860px){
      .layout{grid-template-columns:1fr; }
      .vertical-add{min-width:100%}
      .controls-top{ flex-direction:column; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">SUB</div>
      <div>
        <h1>Subtraction with Regrouping</h1>
        <p class="lead">Interactive page for learning subtraction with regrouping.</p>
      </div>
    </header>

    <!-- TOP SETTINGS -->
    <div class="controls-top">
      <div class="card" aria-labelledby="lesson-settings-heading">
        <h3 id="lesson-settings-heading" style="margin:0 0 6px">Lesson settings</h3>

        <div class="row" style="width:100%">
          <label for="digits" style="flex:0 0 160px">Digits per number</label>
          <select id="digits" title="Select number of digits" style="flex:1">
            <option value="3" selected>3 digits</option>
            <option value="4">4 digits</option>
          </select>
        </div>

        <div class="row" style="width:100%">
          <label style="flex:0 0 160px">Learn how</label>
          <button id="startTutorialBtn" class="btn tiny ghost" style="flex:1">
            Start Tutorial
          </button>
        </div>

        <div class="row" style="width:100%">
          <label style="flex:0 0 160px">Mastery challenge</label>
          <div style="flex:1;color:var(--muted);font-size:13px;padding:8px;border-radius:6px;background:var(--glass)">
            Press "Start Challenge" to try one 5‑digit regroup problem with a 45 second timer. Pass to show mastery and be done with subtraction lessons.
          </div>
          <button id="startChallengeBtn" class="btn tiny" style="margin-left:8px">Start Challenge</button>
        </div>

        <div class="stats" style="margin-top:6px">
          <div class="stat">Asked: <strong id="asked">0</strong></div>
          <div class="stat">Correct: <strong id="correct">0</strong></div>
          <div class="stat">Streak: <strong id="streak">0</strong></div>
        </div>

        <div style="width:100%; margin-top:8px">
          <div class="progress" aria-hidden="true" style="margin-bottom:6px"><i id="progBar"></i></div>
          <div id="sessionInfo" class="hint">Session: 0 / 10 done.</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="downloadBtn" class="btn tiny" disabled>Download PDF</button>
          <div style="flex:1"></div>
          <button id="newLessonBtnTop" class="btn ghost tiny">Start New Lesson</button>
        </div>
      </div>
    </div>

    <div class="layout" style="margin-top:18px">
      <!-- LEFT HELPERS -->
      <aside class="card" aria-labelledby="helpers-heading">
        <h4 id="helpers-heading" style="margin-top:0">Helpers</h4>

        <!-- Borrowing helper text -->
        <div id="subtractionHelper" style="margin-top:6px">
          <h4 style="margin:6px 0 8px;font-size:14px">Borrowing Guide</h4>
          <div style="font-size:13px;color:var(--muted);line-height:1.6">
            <p style="margin:8px 0"><strong style="color:var(--accent)">Steps for Borrowing:</strong></p>
            <ol style="padding-left:20px;margin:8px 0">
              <li style="margin:6px 0">Work from right to left (ones to tens to hundreds)</li>
              <li style="margin:6px 0">If top digit &lt; bottom digit, borrow from the left</li>
              <li style="margin:6px 0">Click the top digit you are borrowing <strong>from</strong></li>
              <li style="margin:6px 0">That sends a 10 to the digit on the right and reduces the one you clicked by 1</li>
            </ol>
          </div>
        </div>

        <!-- NEW: Place-based subtraction helper (ones / tens) -->
        <div id="placeHelper" style="margin-top:12px">
          <h4 style="margin:6px 0 8px;font-size:14px">Place Value Helper</h4>
          <div style="font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:4px">
            For a column like <strong>14 − 6</strong> in the ones place, we can show 14 dots and dim 6 of them to see that 8 are left.
          </div>

          <!-- Ones helper row -->
          <div class="place-helper-row">
            <div class="place-helper-label">
              <span>Ones column</span>
              <button id="onesHelperBtn" class="btn tiny ghost" style="font-size:11px;padding-inline:8px;">Use ones</button>
            </div>
            <div id="onesHelperGrid" class="place-helper-grid" aria-label="Ones place helper"></div>
            <div id="onesHelperSummary" class="place-helper-summary">
              Click "Use ones" to show dots for the ones column.
            </div>
          </div>

          <!-- Tens helper row -->
          <div class="place-helper-row">
            <div class="place-helper-label">
              <span>Tens column</span>
              <button id="tensHelperBtn" class="btn tiny ghost" style="font-size:11px;padding-inline:8px;">Use tens</button>
            </div>
            <div id="tensHelperGrid" class="place-helper-grid" aria-label="Tens place helper"></div>
            <div id="tensHelperSummary" class="place-helper-summary">
              Click "Use tens" to show dots for the tens column.
            </div>
          </div>
        </div>
      </aside>

      <!-- MAIN PROBLEM AREA -->
      <main class="card stage" aria-live="polite">
        <div class="problem-card" id="problemCard">
          <div class="vertical-add" id="verticalAdd" role="group" aria-label="Subtraction problem">
            <!-- numbers -->
            <div id="addendRowA" class="grid-row" aria-hidden="true" title="Minuend"></div>
            <div id="addendRowB" class="grid-row" aria-hidden="true" title="Subtrahend"></div>

            <div class="separator" aria-hidden="true"></div>

            <!-- answer row -->
            <div class="grid-row" id="sumRow" role="group" aria-label="Your answer"></div>

            <div class="hint" id="problemHint">Generate a new problem to begin.</div>
          </div>

          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-size:12px;color:var(--muted)">Current mode</div>
                <div id="modeLabel" style="font-weight:700">Practice</div>
              </div>
            </div>

            <div id="explain" class="explain" hidden>
              <div id="explainText">Explanation</div>
            </div>

            <!-- Buttons under current problem -->
            <div id="problemControls" style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <button id="newBtn" class="btn tiny" title="Next problem" disabled>Next problem</button>
              <button id="checkBtn" class="btn ghost tiny" title="Check answer">Check</button>
              <button id="explainBtn" class="btn ghost tiny" title="Show step-by-step">Explain</button>

              <div style="flex:1"></div>
              <div id="timerWrap" style="display:none;align-items:center;gap:8px">
                <div class="timer-badge" id="timer">0:45</div>
                <button id="retryBtn" class="btn ghost tiny" style="display:none">Retry</button>
              </div>
            </div>

          </div>
        </div>

        <!-- Solved problems (unchanged content) -->
        <div id="solvedCard" class="card solved-card" hidden>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Solved problems</div>
            <div style="font-size:13px;color:var(--muted)">Solved in this session</div>
          </div>
          <div id="solvedList" class="solved-list" aria-live="polite"></div>
          <div class="solved-controls">
            <div style="font-size:13px;color:var(--muted)">When 10 problems are solved you can download your work.</div>
            <div style="flex:1"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // DOM refs
    const digitsSelect = document.getElementById('digits');
    const startChallengeBtn = document.getElementById('startChallengeBtn');
    const modeLabel = document.getElementById('modeLabel');

    const newBtn = document.getElementById('newBtn');
    const checkBtn = document.getElementById('checkBtn');
    const explainBtn = document.getElementById('explainBtn');
    const retryBtn = document.getElementById('retryBtn');
    const timerWrap = document.getElementById('timerWrap');
    const timerEl = document.getElementById('timer');
    const newLessonBtnTop = document.getElementById('newLessonBtnTop');

    const addendRowA = document.getElementById('addendRowA');
    const addendRowB = document.getElementById('addendRowB');
    const sumRow = document.getElementById('sumRow');
    const problemHint = document.getElementById('problemHint');

    const explainBox = document.getElementById('explain');
    const explainText = document.getElementById('explainText');

    const solvedCard = document.getElementById('solvedCard');
    const solvedList = document.getElementById('solvedList');
    const downloadBtn = document.getElementById('downloadBtn');

    const askedEl = document.getElementById('asked');
    const correctEl = document.getElementById('correct');
    const streakEl = document.getElementById('streak');
    const progBar = document.getElementById('progBar');
    const sessionInfo = document.getElementById('sessionInfo');

    const startTutorialBtn = document.getElementById('startTutorialBtn');

    // NEW: place helper DOM
    const onesHelperGrid = document.getElementById('onesHelperGrid');
    const tensHelperGrid = document.getElementById('tensHelperGrid');
    const onesHelperSummary = document.getElementById('onesHelperSummary');
    const tensHelperSummary = document.getElementById('tensHelperSummary');
    const onesHelperBtn = document.getElementById('onesHelperBtn');
    const tensHelperBtn = document.getElementById('tensHelperBtn');

    let state = {
      a: null,
      b: null,
      digits: 3,
      asked: 0,
      correct: 0,
      streak: 0,
      sessionTotal: 10,
      sessionDone: 0,
      solved: [],
      current: null,
      inChallenge: false
    };

    // For visual borrowing
    let borrowMarks = [];

    // Challenge timer
    let challengeTimer = null;
    let challengeTimeRemaining = 0;
    const CHALLENGE_SECONDS = 45;

    // Storage
    const STORAGE_KEY = 'subtraction_session_state';
    const DOWNLOAD_THRESHOLD = 10;

    function saveStateToLocalStorage() {
      const stateToSave = {
        asked: state.asked,
        correct: state.correct,
        streak: state.streak,
        sessionDone: state.sessionDone,
        solved: state.solved,
        digits: state.digits
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
      } catch(e) {
        console.error('Failed to save to localStorage:', e);
      }
    }

    function loadStateFromLocalStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          state.asked = parsed.asked ?? 0;
          state.correct = parsed.correct ?? 0;
          state.streak = parsed.streak ?? 0;
          state.sessionDone = parsed.sessionDone ?? 0;
          state.solved = parsed.solved ?? [];
          state.digits = parsed.digits ?? 3;

          askedEl.textContent = state.asked;
          correctEl.textContent = state.correct;
          streakEl.textContent = state.streak;
          digitsSelect.value = state.digits;

          if (state.solved.length > 0) {
            renderSolvedList();
            solvedCard.hidden = false;
            downloadBtn.disabled = state.solved.length < DOWNLOAD_THRESHOLD;
          }

          updateProgress();
          return true;
        }
      } catch(e) {
        console.error('Failed to load from localStorage:', e);
      }
      return false;
    }

    function startNewLesson() {
      if (state.asked > 0) {
        const confirmed = confirm('Are you sure you want to start a new lesson? This will clear all saved progress from the current session.');
        if (!confirmed) return;
      }

      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch(e) {
        console.error('Failed to clear localStorage:', e);
      }

      state.asked = 0;
      state.correct = 0;
      state.streak = 0;
      state.sessionDone = 0;
      state.solved = [];
      state.current = null;
      state.inChallenge = false;

      askedEl.textContent = state.asked;
      correctEl.textContent = state.correct;
      streakEl.textContent = state.streak;
      solvedCard.hidden = true;
      solvedList.innerHTML = '';
      downloadBtn.disabled = true;
      updateProgress();

      modeLabel.textContent = 'Practice';
      digitsSelect.disabled = false;

      stopChallengeTimer();
      timerWrap.style.display = 'none';
      retryBtn.style.display = 'none';

      newProblem();
    }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function makeAddends(digits){
      while(true){
        const max = Math.pow(10,digits)-1;
        const min = Math.pow(10,digits-1);
        let a = randInt(min, max);
        let b = randInt(min, max);
        if(a < b){ [a,b] = [b,a]; }
        if(a === b) continue;
        const hasRegroup = (() => {
          for(let i=0;i<digits;i++){
            const pow=Math.pow(10,i);
            const da = Math.floor(a/pow)%10;
            const db = Math.floor(b/pow)%10;
            if(da < db) return true;
          }
          return false;
        })();
        if(!hasRegroup) continue;
        return {a,b};
      }
    }

    function computeDifferenceArrayFor(a,b,d){
      const total = a - b;
      const arr=[];
      for(let i=0;i<=d;i++){
        arr.push(Math.floor(total/Math.pow(10,i))%10);
      }
      return arr;
    }

    function renderProblem(){
      const d = state.digits, a = state.a, b = state.b;
      borrowMarks = new Array(d).fill(false);

      addendRowA.innerHTML = '';
      addendRowB.innerHTML = '';
      sumRow.innerHTML = '';

      for(let i=0;i<d;i++){
        const pow = Math.pow(10,i);
        const da = Math.floor(a/pow)%10;
        const db = Math.floor(b/pow)%10;
        
        const cellA = document.createElement('div'); 
        cellA.className='digit-cell clickable-minuend';
        cellA.dataset.originalDigit = da;
        cellA.dataset.columnIndex = i;
        cellA.innerHTML = `<span class="digit-display">${da}</span>`;
        cellA.addEventListener('click', () => handleBorrowClickFromColumn(i));
        cellA.setAttribute('title', 'Click to borrow from this digit');
        
        const cellB = document.createElement('div'); 
        cellB.className='digit-cell'; 
        cellB.textContent=db;
        
        addendRowA.appendChild(cellA);
        addendRowB.appendChild(cellB);
      }

      for(let i=0;i<=d;i++){
        const input = document.createElement('input');
        input.type='text';
        input.inputMode='numeric';
        input.pattern='[0-9]*';
        input.maxLength=1;
        input.className='digit-input';
        input.dataset.idx = i;
        input.setAttribute('aria-label','digit '+(i+1));
        input.addEventListener('keydown', handleKeyNav);
        input.addEventListener('input', e => {
          e.target.value = e.target.value.replace(/\D/g,'').slice(0,1);
        });
        input.addEventListener('paste', e => {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData('text');
          input.value = (text.match(/\d/) || [''])[0];
        });
        sumRow.appendChild(input);
      }

      problemHint.textContent = `Subtract ${state.b} from ${state.a}. Rightmost box is ones.`;
      explainBox.hidden = true;

      newBtn.disabled = true;
      checkBtn.disabled = false;
      explainBtn.disabled = false;
      retryBtn.style.display = 'none';

      setTimeout(() => {
        const inputs = sumRow.querySelectorAll('input');
        if(inputs.length) inputs[0].focus();
      }, 50);

      updateBorrowVisualization();
      clearPlaceHelperGrids();
    }

    // Borrowing: click the digit we are BORROWING FROM (column k)
    // sends a "1" to column k-1 (right) and decrements k.
    function handleBorrowClickFromColumn(colIndex) {
      const d = state.digits;
      const minuendCells = Array.from(addendRowA.querySelectorAll('.digit-cell'));

      if (colIndex === 0) return;
      if (colIndex < 0 || colIndex >= d) return;

      const receiver = colIndex - 1;
      borrowMarks[receiver] = !borrowMarks[receiver];

      const lenderCell = minuendCells.find(c => parseInt(c.dataset.columnIndex,10) === colIndex);
      if (lenderCell) {
        lenderCell.classList.add('borrowed-indicator');
        setTimeout(() => lenderCell.classList.remove('borrowed-indicator'), 600);
      }

      updateBorrowVisualization();
    }

    function updateBorrowVisualization() {
      const minuendCells = Array.from(addendRowA.querySelectorAll('.digit-cell'));
      const maxIndex = minuendCells.length - 1;

      minuendCells.forEach(cell => {
        const originalDigit = cell.dataset.originalDigit;
        cell.innerHTML = `<span class="digit-display">${originalDigit}</span>`;
      });

      for (let receiver = 0; receiver < borrowMarks.length; receiver++) {
        if (!borrowMarks[receiver]) continue;
        const lender = receiver + 1;

        if (receiver >= 0 && receiver <= maxIndex) {
          const receiverCell = minuendCells[receiver];
          const originalDigit = parseInt(receiverCell.dataset.originalDigit, 10);
          receiverCell.innerHTML = `
            <div class="regrouped-value">
              <span class="borrowed-prefix">1</span>${originalDigit}
            </div>
          `;
        }

        if (lender >= 0 && lender <= maxIndex) {
          const lenderCell = minuendCells[lender];
          const originalDigit = parseInt(lenderCell.dataset.originalDigit, 10);
          const reducedDigit = originalDigit - 1;
          lenderCell.innerHTML = `
            <span class="crossed-out">${originalDigit}</span>
            <span class="digit-display">${reducedDigit}</span>
          `;
        }
      }
    }

    function analyzeSubtractionErrors(userDigits, expectedDigits, minuend, subtrahend, digits) {
      const errors = [];
      let borrow = 0;
      const placeNames = ['ones', 'tens', 'hundreds', 'thousands', 'ten-thousands'];
      
      for(let i = 0; i < digits; i++) {
        let da = Math.floor(minuend / Math.pow(10, i)) % 10;
        const db = Math.floor(subtrahend / Math.pow(10, i)) % 10;
        
        da -= borrow;
        const needsBorrow = da < db;
        
        if(userDigits[i] !== expectedDigits[i]) {
          const placeName = placeNames[i] || `${i+1}-place`;
          
          if(needsBorrow && userDigits[i] === (da - db)) {
            errors.push(`${placeName}: You forgot to borrow! ${da} < ${db}, so you need to borrow from the ${placeNames[i + 1] || 'next'} place.`);
          } else if(needsBorrow) {
            const correctValue = (da + 10) - db;
            errors.push(`${placeName}: After borrowing, ${da} becomes ${da + 10}. ${da + 10} - ${db} = ${correctValue}.`);
          } else {
            errors.push(`${placeName}: Expected ${expectedDigits[i]}, you wrote ${userDigits[i]}.`);
          }
        }
        
        borrow = needsBorrow ? 1 : 0;
      }
      
      return {
        message: errors.length > 0 ? errors[0] : 'Not quite — try again.',
        allErrors: errors
      };
    }

    function handleKeyNav(e){
      const idx = Number(e.target.dataset.idx);
      const inputs = Array.from(sumRow.querySelectorAll('input'));
      if(e.key === 'ArrowLeft'){
        e.preventDefault();
        if(idx+1 < inputs.length) inputs[idx+1].focus();
      } else if(e.key === 'ArrowRight'){
        e.preventDefault();
        if(idx-1 >= 0) inputs[idx-1].focus();
      } else if(e.key === 'Enter'){
        e.preventDefault();
        checkAnswer();
      }
    }

    function getUserDigits(){
      const inputs = Array.from(sumRow.querySelectorAll('input'));
      return inputs.map(i => {
        const v = i.value.trim();
        return v === '' ? 0 : parseInt(v,10);
      });
    }
    function getUserDigitsRaw(){
      const inputs = Array.from(sumRow.querySelectorAll('input'));
      return inputs.map(i => i.value);
    }

    function checkAnswer(){
      if (state.inChallenge && challengeTimeRemaining <= 0) return;

      const user = getUserDigits();
      const userRaw = getUserDigitsRaw();
      const expected = computeDifferenceArrayFor(state.a, state.b, state.digits);

      let allGood = true;
      const inputs = Array.from(sumRow.querySelectorAll('input'));
      inputs.forEach(i => {
        i.style.border='1px dashed rgba(255,255,255,0.05)';
        i.style.background = 'transparent';
      });

      for(let i=0;i<expected.length;i++){
        if(user[i] === expected[i]){
          inputs[i].style.background = 'linear-gradient(90deg, rgba(34,211,238,0.06), rgba(124,58,237,0.02))';
          inputs[i].style.border = '1px solid rgba(34,211,238,0.18)';
        } else {
          inputs[i].style.background = 'linear-gradient(90deg, rgba(239,68,68,0.02), transparent)';
          inputs[i].style.border = '1px solid rgba(239,68,68,0.18)';
          allGood = false;
        }
      }

      if(allGood){
        flashProblem('Correct! Nice work.', true);
        state.correct++;
        state.streak++;
        correctEl.textContent = state.correct;
        streakEl.textContent = state.streak;
        confetti();

        if(state.inChallenge){
          stopChallengeTimer();
          explainText.innerHTML = `<div style="font-weight:700;color:#e6eef6;margin-bottom:6px">Challenge</div>
<div class="step-list">
<strong style="color:var(--good)">Passed!</strong> You solved the 5-digit regrouping problem within the time limit.
</div>`;
          explainBox.hidden = false;
        }
      } else {
        const errorDetails = analyzeSubtractionErrors(user, expected, state.a, state.b, state.digits);
        flashProblem(errorDetails.message, false);
        state.streak = 0;
        streakEl.textContent = state.streak;
      }

      if(!state.current){
        state.current = {
          a: state.a, b: state.b, digits: state.digits,
          expectedDigits: expected.slice(),
          attempts: 0,
          finalized: false,
          startTime: new Date().toISOString()
        };
      }
      state.current.attempts++;
      state.current.lastAttempt = {
        userDigitsRaw: userRaw.slice(),
        borrowMarks: borrowMarks.slice(),
        correct: allGood,
        timestamp: new Date().toISOString()
      };

      if(allGood && !state.current.finalized){
        finalizeCurrentProblem(true);
      }
    }

    function flashProblem(msg, good){
      const card = document.getElementById('verticalAdd');
      card.classList.remove('correct','wrong');
      if(good) card.classList.add('correct'); else card.classList.add('wrong');
      problemHint.textContent = msg;
      setTimeout(()=>{ card.classList.remove('correct','wrong'); }, 1400);
    }

    function showExplanation(){
      const d = state.digits;
      const a = state.a;
      const b = state.b;

      if(a == null || b == null) return;

      const steps = [];
      steps.push(`We are subtracting ${b} from ${a}. Remember to work from right (ones) to left.`);

      let borrow = 0;
      for(let i=0;i<d;i++){
        const pow = Math.pow(10,i);
        let da = Math.floor(a/pow)%10;
        const db = Math.floor(b/pow)%10;
        const placeNames = ['ones','tens','hundreds','thousands','ten-thousands'];
        const place = placeNames[i] || `place ${i+1}`;

        da -= borrow;
        if(da < db){
          steps.push(`In the ${place} column: ${da} is less than ${db}, so we borrow 1 from the next column to the left.`);
          steps.push(`That makes this column ${da + 10}. Now we do ${da + 10} − ${db}.`);
          borrow = 1;
        } else {
          steps.push(`In the ${place} column: we can subtract directly: ${da} − ${db}.`);
          borrow = 0;
        }
      }

      const result = a - b;
      steps.push(`Finally, the answer is ${result}.`);

      explainText.innerHTML = steps.map(s => `• ${s}`).join('\n');
      explainBox.hidden = false;
    }

    function newProblem(){
      if(!state.inChallenge){
        state.digits = parseInt(digitsSelect.value,10);
      }

      const {a,b} = makeAddends(state.digits);
      state.a = a;
      state.b = b;
      state.asked++;
      askedEl.textContent = state.asked;
      state.current = null;

      renderProblem();
      problemHint.textContent = 'Fill in your answer and press "Check".';

      updateProgress();
      saveStateToLocalStorage();
    }

    function finalizeCurrentProblem(correct){
      if(!state.current) return;
      state.current.finalized = true;
      state.current.correct = !!correct;
      state.current.endTime = new Date().toISOString();
      state.solved.unshift(state.current);
      state.sessionDone++;
      updateProgress();
      renderSolvedList();
      solvedCard.hidden = false;

      newBtn.disabled = false;
      downloadBtn.disabled = state.solved.length < DOWNLOAD_THRESHOLD;

      saveStateToLocalStorage();
    }

    function renderSolvedList(){
      solvedList.innerHTML = '';
      state.solved.forEach((item, index) => {
        const container = document.createElement('div');
        container.className = 'solved-item';

        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:600">${item.a} − ${item.b}</div>
<div style="font-size:12px;color:var(--muted)">Attempts: ${item.attempts}</div>`;

        const right = document.createElement('div');
        right.className = 'right';
        const status = document.createElement('span');
        status.textContent = item.correct ? 'Correct' : 'Incorrect';
        status.className = item.correct ? 'solved-correct' : 'solved-wrong';
        right.appendChild(status);

        container.appendChild(left);
        container.appendChild(right);
        solvedList.appendChild(container);
      });
    }

    function updateProgress(){
      const pct = state.sessionTotal ? Math.min(100, (state.sessionDone/state.sessionTotal)*100) : 0;
      progBar.style.width = pct + '%';
      sessionInfo.textContent = `Session: ${state.sessionDone} / ${state.sessionTotal} done.`;
    }

    function confetti(){
      const body = document.body;
      body.style.transition = 'background-color 0.2s ease';
      const old = body.style.backgroundColor;
      body.style.backgroundColor = '#0b1830';
      setTimeout(()=>{ body.style.backgroundColor = old; }, 200);
    }

    // Timer helpers
    function startChallengeTimer(){
      stopChallengeTimer();
      challengeTimeRemaining = CHALLENGE_SECONDS;
      timerWrap.style.display = 'flex';
      retryBtn.style.display = 'none';
      updateTimerDisplay();

      challengeTimer = setInterval(() => {
        challengeTimeRemaining--;
        if(challengeTimeRemaining <= 0){
          challengeTimeRemaining = 0;
          updateTimerDisplay();
          stopChallengeTimer();
          handleChallengeTimeout();
        } else {
          updateTimerDisplay();
        }
      }, 1000);
    }

    function stopChallengeTimer(){
      if(challengeTimer){
        clearInterval(challengeTimer);
        challengeTimer = null;
      }
    }

    function updateTimerDisplay(){
      const seconds = challengeTimeRemaining;
      const m = Math.floor(seconds/60);
      const s = seconds%60;
      timerEl.textContent = `${m}:${s.toString().padStart(2,'0')}`;
    }

    function handleChallengeTimeout(){
      flashProblem('Time is up! You can press Retry to try the challenge again.', false);
      checkBtn.disabled = true;
      explainBtn.disabled = false;
      retryBtn.style.display = 'inline-flex';
      modeLabel.textContent = 'Challenge (time up)';
    }

    // Tutorial overlay (unchanged)
    function showTutorial(){
      const overlay = document.createElement('div');
      overlay.className = 'tutorial-overlay';
      overlay.setAttribute('role','dialog');
      overlay.setAttribute('aria-modal','true');

      overlay.innerHTML = `
        <div class="tutorial-content">
          <h2>How to Subtract with Borrowing</h2>
          <p>This quick tutorial walks through an example of borrowing (regrouping) when subtracting.</p>
          <div class="tutorial-step">
            <strong>1. Start at the ones place</strong>
            <p>Look at the rightmost digits. If the top digit is smaller than the bottom, you cannot subtract directly.</p>
          </div>
          <div class="tutorial-step">
            <strong>2. Borrow from the next place</strong>
            <p>Click the digit to the left to borrow from it. That digit goes down by 1, and you add 10 to the digit you are working with.</p>
          </div>
          <div class="tutorial-step">
            <strong>3. Subtract and move left</strong>
            <p>Now subtract in that column, then move left and repeat as needed.</p>
          </div>
          <div class="tutorial-controls">
            <button id="closeTutorialBtn" class="btn tiny ghost">Close tutorial</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      document.getElementById('closeTutorialBtn').addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
    }

    // Download stub
    function downloadPDF(){
      if(state.solved.length < DOWNLOAD_THRESHOLD){
        alert(`Solve at least ${DOWNLOAD_THRESHOLD} problems before downloading your work.`);
        return;
      }
      const lines = [];
      lines.push('Subtraction with Regrouping - Session Summary');
      lines.push('');
      state.solved.forEach((item, index) => {
        const result = item.a - item.b;
        lines.push(`${index+1}. ${item.a} - ${item.b} = ${result}  (${item.correct ? 'correct' : 'incorrect'}, attempts: ${item.attempts})`);
      });

      const blob = new Blob([lines.join('\n')], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'subtraction-session.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    // NEW: Place helper logic
    function buildPlaceHelperGrid(container){
      container.innerHTML = '';
      // 20 tiles (two rows of 10) gives enough room for 14, 18, etc.
      for (let i = 0; i < 20; i++) {
        const tile = document.createElement('div');
        tile.className = 'place-tile';
        container.appendChild(tile);
      }
    }

    function clearPlaceHelperGrids(){
      [onesHelperGrid, tensHelperGrid].forEach(grid => {
        Array.from(grid.children).forEach(tile => {
          tile.classList.remove('filled','dimmed');
        });
      });
      onesHelperSummary.textContent = 'Click "Use ones" to show dots for the ones column.';
      tensHelperSummary.textContent = 'Click "Use tens" to show dots for the tens column.';
    }

    // Show minuend digit as bright dots, subtrahend digit as dimmed dots
    function showPlaceHelper(grid, summaryEl, placeIndex){
      if (state.a == null || state.b == null) {
        summaryEl.textContent = 'Generate a problem first.';
        return;
      }
      const d = state.digits;
      if (placeIndex >= d) {
        summaryEl.textContent = 'This column is not used in this problem.';
        return;
      }

      const pow = Math.pow(10, placeIndex);
      let topDigit = Math.floor(state.a / pow) % 10;
      let bottomDigit = Math.floor(state.b / pow) % 10;

      // If we've borrowed into this place, conceptually treat the topDigit as 10+topDigit
      // for visualization of something like 14 - 6.
      if (borrowMarks[placeIndex]) {
        topDigit += 10;
      }

      const tiles = Array.from(grid.children);
      tiles.forEach(tile => tile.classList.remove('filled','dimmed'));

      // Clamp to grid size
      const maxDots = tiles.length;
      const totalDots = Math.min(topDigit, maxDots);
      const dimCount = Math.min(bottomDigit, totalDots);
      const brightCount = totalDots - dimCount;

      // Fill: first the bright (kept) ones, then dimmed (taken away) ones,
      // so visually you see "leftover" clearly.
      let idx = 0;
      for (let i=0; i<brightCount && idx<maxDots; i++, idx++){
        tiles[idx].classList.add('filled');
      }
      for (let i=0; i<dimCount && idx<maxDots; i++, idx++){
        tiles[idx].classList.add('dimmed');
      }

      if (totalDots === 0){
        summaryEl.textContent = 'There are 0 in this column.';
      } else {
        summaryEl.textContent = `Top has ${topDigit}, we take away ${bottomDigit}. ${brightCount} dots stay bright, so the answer digit here is ${brightCount}.`;
      }
    }

    // Event wiring
    digitsSelect.addEventListener('change', () => {
      if(!state.inChallenge){
        state.digits = parseInt(digitsSelect.value,10);
        newProblem();
      }
    });

    newBtn.addEventListener('click', () => {
      if(state.inChallenge){
        startChallenge();
      } else {
        newProblem();
      }
    });

    checkBtn.addEventListener('click', checkAnswer);
    explainBtn.addEventListener('click', showExplanation);
    newLessonBtnTop.addEventListener('click', startNewLesson);
    downloadBtn.addEventListener('click', downloadPDF);
    startTutorialBtn.addEventListener('click', showTutorial);

    startChallengeBtn.addEventListener('click', startChallenge);
    retryBtn.addEventListener('click', startChallenge);

    // Place helper buttons: placeIndex 0 = ones, 1 = tens
    onesHelperBtn.addEventListener('click', () => showPlaceHelper(onesHelperGrid, onesHelperSummary, 0));
    tensHelperBtn.addEventListener('click', () => showPlaceHelper(tensHelperGrid, tensHelperSummary, 1));

    function startChallenge(){
      state.inChallenge = true;
      modeLabel.textContent = 'Challenge (5-digit with regrouping)';
      digitsSelect.disabled = true;
      state.digits = 5;

      const addends = makeAddends(state.digits);
      state.a = addends.a;
      state.b = addends.b;

      state.current = null;
      renderProblem();
      problemHint.textContent = 'Solve this 5-digit regrouping problem before the timer runs out!';
      checkBtn.disabled = false;
      explainBtn.disabled = false;
      retryBtn.style.display = 'none';

      startChallengeTimer();
    }

    window.addEventListener('load', () => {
      // build place helper grids
      buildPlaceHelperGrid(onesHelperGrid);
      buildPlaceHelperGrid(tensHelperGrid);

      const restored = loadStateFromLocalStorage();
      if(!restored){
        newProblem();
      }
    });
  </script>
</body>
</html>
